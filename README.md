# ğŸ§  3D U-Net è„‘è‚¿ç˜¤åˆ†å‰²é¡¹ç›®

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![PyTorch](https://img.shields.io/badge/PyTorch-1.7+-red.svg)](https://pytorch.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

åŸºäº**BraTS2021æ•°æ®é›†**çš„é«˜æ€§èƒ½3Dè„‘è‚¿ç˜¤åˆ†å‰²è§£å†³æ–¹æ¡ˆï¼Œé‡‡ç”¨å…ˆè¿›çš„3D U-Netæ·±åº¦å­¦ä¹ æ¶æ„ã€‚æœ¬é¡¹ç›®æä¾›äº†ä»æ•°æ®é¢„å¤„ç†åˆ°æ¨¡å‹éƒ¨ç½²çš„å®Œæ•´å·¥ä½œæµï¼Œæ”¯æŒå¤šæ¨¡æ€MRIå›¾åƒçš„è‡ªåŠ¨åˆ†å‰²ï¼Œå¯å‡†ç¡®è¯†åˆ«åæ­»æ ¸å¿ƒã€æ°´è‚¿åŒºåŸŸå’Œå¢å¼ºè‚¿ç˜¤ç­‰å…³é”®ç—…ç†ç»“æ„ã€‚

## âœ¨ é¡¹ç›®ç‰¹è‰²

- ğŸ¥ **åŒ»å­¦ä¸“ä¸šæ€§**ï¼šä¸“ä¸ºè„‘è‚¿ç˜¤åˆ†å‰²ä¼˜åŒ–ï¼Œç¬¦åˆä¸´åºŠåº”ç”¨æ ‡å‡†
- ğŸš€ **é«˜æ€§èƒ½æ¶æ„**ï¼š3D U-Net + æ®‹å·®è¿æ¥ + æ·±åº¦ç›‘ç£ï¼Œè¾¾åˆ°SOTAæ€§èƒ½
- ğŸ”§ **å®Œæ•´å·¥å…·é“¾**ï¼šæ•°æ®é¢„å¤„ç†ã€è®­ç»ƒã€éªŒè¯ã€æ¨ç†ã€å¯è§†åŒ–ä¸€ä½“åŒ–
- âš¡ **è®­ç»ƒåŠ é€Ÿ**ï¼šæ”¯æŒæ··åˆç²¾åº¦è®­ç»ƒå’Œåˆ†å¸ƒå¼è®­ç»ƒï¼Œæ˜¾è‘—æå‡æ•ˆç‡
- ğŸ“Š **ä¸°å¯Œå¯è§†åŒ–**ï¼š2Dåˆ‡ç‰‡å¯¹æ¯”ã€3DåŠ¨ç”»ã€è®­ç»ƒç›‘æ§ç­‰å¤šç§å¯è§†åŒ–æ–¹å¼
- ğŸ›¡ï¸ **é²æ£’è®¾è®¡**ï¼šå…¨é¢çš„é”™è¯¯å¤„ç†å’Œæ•°æ®éªŒè¯ï¼Œç¡®ä¿ç”Ÿäº§ç¯å¢ƒç¨³å®šæ€§

## ğŸ“ é¡¹ç›®ç»“æ„

```
3D-UNet-BraTS/
â”œâ”€â”€ ğŸ“‚ data/                           # æ•°æ®å­˜å‚¨ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“‚ BraTS2021_Training_Data/    # åŸå§‹BraTS2021æ•°æ®é›†
â”‚   â”‚   â”œâ”€â”€ ğŸ“‚ BraTS2021_00000/        # å•ä¸ªç—…ä¾‹æ–‡ä»¶å¤¹
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ§  *_t1.nii.gz         # T1åŠ æƒMRI
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ§  *_t1ce.nii.gz       # T1å¯¹æ¯”å¢å¼ºMRI
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ§  *_t2.nii.gz         # T2åŠ æƒMRI
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ§  *_flair.nii.gz      # FLAIRåºåˆ—MRI
â”‚   â”‚   â”‚   â””â”€â”€ ğŸ¯ *_seg.nii.gz        # åˆ†å‰²æ ‡æ³¨
â”‚   â”‚   â””â”€â”€ ğŸ“‚ ...                     # æ›´å¤šç—…ä¾‹
â”‚   â””â”€â”€ ğŸ“‚ processed/                  # é¢„å¤„ç†åçš„æ•°æ®ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ ğŸ“‚ models/                         # æ·±åº¦å­¦ä¹ æ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ ğŸ—ï¸ unet3d.py                   # 3D U-Netæ ¸å¿ƒæ¶æ„
â”œâ”€â”€ ğŸ“‚ utils/                          # å·¥å…·å‡½æ•°åº“
â”‚   â”œâ”€â”€ ğŸ”§ data_utils.py               # æ•°æ®åŠ è½½ä¸é¢„å¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ ğŸ“Š metrics.py                  # è¯„ä¼°æŒ‡æ ‡è®¡ç®—
â”‚   â””â”€â”€ ğŸ¨ visualization.py            # å¯è§†åŒ–å·¥å…·é›†
â”œâ”€â”€ ğŸ“‚ output/                         # è®­ç»ƒè¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ ğŸ“‚ checkpoints/                # æ¨¡å‹æ£€æŸ¥ç‚¹å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ ğŸ† best_model.pth          # æœ€ä½³æ¨¡å‹æƒé‡
â”‚   â”‚   â””â”€â”€ ğŸ“ model_epoch_*.pth       # å®šæœŸä¿å­˜çš„æ£€æŸ¥ç‚¹
â”‚   â”œâ”€â”€ ğŸ“‚ logs/                       # TensorBoardè®­ç»ƒæ—¥å¿—
â”‚   â””â”€â”€ ğŸ“‚ visualizations/             # å¯è§†åŒ–ç»“æœ
â”‚       â”œâ”€â”€ ğŸ–¼ï¸ *.png                   # 2Dåˆ‡ç‰‡å¯¹æ¯”å›¾
â”‚       â””â”€â”€ ğŸ¬ *.gif                   # 3DåŠ¨ç”»å¯è§†åŒ–
â”œâ”€â”€ ğŸš€ train.py                        # æ¨¡å‹è®­ç»ƒä¸»è„šæœ¬
â”œâ”€â”€ ğŸ”® inference.py                    # æ¨¡å‹æ¨ç†è„šæœ¬
â”œâ”€â”€ ğŸ“‹ requirements.txt                # Pythonä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ ğŸ“– README.md                       # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## ğŸ› ï¸ ç¯å¢ƒé…ç½®

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinux (æ¨è) / Windows / macOS
- **Pythonç‰ˆæœ¬**ï¼š3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **GPUè¦æ±‚**ï¼šNVIDIA GPU (æ¨èæ˜¾å­˜ â‰¥ 8GB)
- **å†…å­˜è¦æ±‚**ï¼šâ‰¥ 16GB RAM (æ¨è 32GB)
- **å­˜å‚¨ç©ºé—´**ï¼šâ‰¥ 50GB å¯ç”¨ç©ºé—´

### å¿«é€Ÿå®‰è£…

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨Condaï¼ˆæ¨èï¼‰

```bash
# åˆ›å»ºä¸“ç”¨è™šæ‹Ÿç¯å¢ƒ
conda create -n unet3d python=3.8 -y
conda activate unet3d

# å®‰è£…PyTorch (æ ¹æ®ä½ çš„CUDAç‰ˆæœ¬é€‰æ‹©)
conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia

# å®‰è£…å…¶ä»–ä¾èµ–
pip install -r requirements.txt
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨pip

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv unet3d_env
source unet3d_env/bin/activate  # Linux/macOS
# æˆ–è€… unet3d_env\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### éªŒè¯å®‰è£…

```bash
python -c "import torch; print(f'PyTorchç‰ˆæœ¬: {torch.__version__}'); print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}')"
```

## ğŸ“Š æ•°æ®å‡†å¤‡

### BraTS2021æ•°æ®é›†ä»‹ç»

æœ¬é¡¹ç›®ä½¿ç”¨**BraTS2021 (Brain Tumor Segmentation Challenge 2021)** æ•°æ®é›†ï¼Œè¿™æ˜¯åŒ»å­¦å›¾åƒåˆ†å‰²é¢†åŸŸçš„æƒå¨åŸºå‡†æ•°æ®é›†ã€‚

**æ•°æ®é›†ç‰¹ç‚¹ï¼š**
- ğŸ¥ **ä¸´åºŠçœŸå®æ€§**ï¼šæ¥è‡ªå¤šä¸ªåŒ»ç–—æœºæ„çš„çœŸå®æ‚£è€…æ•°æ®
- ğŸ§  **å¤šæ¨¡æ€MRI**ï¼šæ¯ä¸ªç—…ä¾‹åŒ…å«4ç§äº’è¡¥çš„MRIåºåˆ—
- ğŸ¯ **ä¸“ä¸šæ ‡æ³¨**ï¼šç”±ç¥ç»æ”¾å°„å­¦ä¸“å®¶æ‰‹å·¥æ ‡æ³¨çš„é«˜è´¨é‡åˆ†å‰²æ©ç 
- ğŸ“ˆ **æ ‡å‡†åŒ–è¯„ä¼°**ï¼šå›½é™…è®¤å¯çš„è¯„ä¼°æ ‡å‡†å’ŒæŒ‡æ ‡

### æ•°æ®è·å–

1. **å®˜æ–¹æ³¨å†Œ**ï¼šè®¿é—® [BraTS Challengeå®˜ç½‘](https://www.med.upenn.edu/cbica/brats2021/) æ³¨å†Œè´¦å·
2. **æ•°æ®ç”³è¯·**ï¼šå¡«å†™æ•°æ®ä½¿ç”¨ç”³è¯·è¡¨ï¼Œè¯´æ˜ç ”ç©¶ç›®çš„
3. **ä¸‹è½½æ•°æ®**ï¼šè·å¾—æ‰¹å‡†åä¸‹è½½è®­ç»ƒæ•°æ®é›†
4. **è§£å‹æ”¾ç½®**ï¼šå°†æ•°æ®è§£å‹åˆ° `data/BraTS2021_Training_Data/` ç›®å½•

### æ•°æ®ç»“æ„è¯´æ˜

æ¯ä¸ªç—…ä¾‹æ–‡ä»¶å¤¹åŒ…å«ä»¥ä¸‹æ ‡å‡†åŒ–æ–‡ä»¶ï¼š

```
BraTS2021_XXXXX/  # ç—…ä¾‹ID
â”œâ”€â”€ BraTS2021_XXXXX_t1.nii.gz      # T1åŠ æƒï¼šè§£å‰–ç»“æ„æ¸…æ™°
â”œâ”€â”€ BraTS2021_XXXXX_t1ce.nii.gz    # T1å¯¹æ¯”å¢å¼ºï¼šè‚¿ç˜¤è¾¹ç•Œçªå‡º
â”œâ”€â”€ BraTS2021_XXXXX_t2.nii.gz      # T2åŠ æƒï¼šæ°´è‚¿åŒºåŸŸæ˜æ˜¾
â”œâ”€â”€ BraTS2021_XXXXX_flair.nii.gz   # FLAIRï¼šæŠ‘åˆ¶è„‘è„Šæ¶²ä¿¡å·
â””â”€â”€ BraTS2021_XXXXX_seg.nii.gz     # åˆ†å‰²æ ‡æ³¨ï¼šä¸“å®¶æ ‡æ³¨çš„çœŸå€¼
```

### æ ‡æ³¨ç±»åˆ«å®šä¹‰

| æ ‡ç­¾å€¼ | è§£å‰–ç»“æ„ | è‹±æ–‡åç§° | ä¸´åºŠæ„ä¹‰ |
|--------|----------|----------|----------|
| 0 | èƒŒæ™¯ | Background | æ­£å¸¸è„‘ç»„ç»‡å’ŒèƒŒæ™¯ |
| 1 | åæ­»æ ¸å¿ƒ | Necrotic Core (NCR) | è‚¿ç˜¤åæ­»åŒºåŸŸ |
| 2 | æ°´è‚¿åŒºåŸŸ | Peritumoral Edema (ED) | è‚¿ç˜¤å‘¨å›´æ°´è‚¿ |
| 4 | å¢å¼ºè‚¿ç˜¤ | Enhancing Tumor (ET) | æ´»è·ƒè‚¿ç˜¤ç»„ç»‡ |

### æ•°æ®éªŒè¯

è¿è¡Œä»¥ä¸‹è„šæœ¬éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼š

```bash
python -c "
from utils.data_utils import BraTSDataset
dataset = BraTSDataset('./data/BraTS2021_Training_Data', mode='train')
print(f'âœ… æ•°æ®é›†åŠ è½½æˆåŠŸï¼å…±æ‰¾åˆ° {len(dataset)} ä¸ªè®­ç»ƒæ ·æœ¬')
"
```

## ğŸ”„ æ•°æ®é¢„å¤„ç†æµç¨‹

æœ¬é¡¹ç›®é‡‡ç”¨æ ‡å‡†åŒ–çš„åŒ»å­¦å›¾åƒé¢„å¤„ç†ç®¡é“ï¼Œç¡®ä¿æ•°æ®è´¨é‡å’Œæ¨¡å‹æ€§èƒ½ï¼š

### æ ¸å¿ƒé¢„å¤„ç†æ­¥éª¤

#### 1. ğŸ¯ å¼ºåº¦å½’ä¸€åŒ–
- **ç›®çš„**ï¼šç»Ÿä¸€ä¸åŒæ¨¡æ€å’Œè®¾å¤‡çš„å¼ºåº¦èŒƒå›´
- **æ–¹æ³•**ï¼šMin-Maxå½’ä¸€åŒ–åˆ° [0, 1] åŒºé—´
- **ä¼˜åŠ¿**ï¼šåŠ é€Ÿæ”¶æ•›ï¼Œæé«˜æ•°å€¼ç¨³å®šæ€§

```python
normalized = (image - image.min()) / (image.max() - image.min())
```

#### 2. âœ‚ï¸ æ™ºèƒ½è„‘éƒ¨è£å‰ª
- **ç›®çš„**ï¼šå»é™¤æ— å…³èƒŒæ™¯ï¼Œèšç„¦è„‘éƒ¨åŒºåŸŸ
- **æ–¹æ³•**ï¼šè‡ªé€‚åº”é˜ˆå€¼ + å½¢æ€å­¦æ“ä½œ
- **æ•ˆæœ**ï¼šå‡å°‘è®¡ç®—é‡ï¼Œæå‡è®­ç»ƒæ•ˆç‡

#### 3. ğŸ“ ç©ºé—´é‡é‡‡æ ·
- **ç›®æ ‡å°ºå¯¸**ï¼š128Ã—128Ã—128 ä½“ç´ 
- **æ’å€¼æ–¹æ³•**ï¼šå›¾åƒæ•°æ®ä½¿ç”¨ä¸‰çº¿æ€§æ’å€¼ï¼Œæ ‡ç­¾ä½¿ç”¨æœ€è¿‘é‚»æ’å€¼
- **æ„ä¹‰**ï¼šç»Ÿä¸€è¾“å…¥å°ºå¯¸ï¼Œæ”¯æŒæ‰¹é‡å¤„ç†

#### 4. ğŸ² æ•°æ®å¢å¼ºï¼ˆä»…è®­ç»ƒæ—¶ï¼‰
- **éšæœº3Dæ—‹è½¬**ï¼šÂ±15Â° èŒƒå›´å†…æ—‹è½¬ï¼Œæ¨¡æ‹Ÿå¤´éƒ¨å§¿æ€å˜åŒ–
- **éšæœºç¿»è½¬**ï¼šæ²¿è§£å‰–å­¦åˆç†çš„è½´è¿›è¡Œé•œåƒç¿»è½¬
- **å¼¹æ€§å˜å½¢**ï¼šæ¨¡æ‹Ÿç»„ç»‡çš„è‡ªç„¶å½¢å˜ï¼Œå¢å¼ºæ³›åŒ–èƒ½åŠ›

### é¢„å¤„ç†é…ç½®

```python
# åœ¨ utils/data_utils.py ä¸­çš„é…ç½®
PREPROCESSING_CONFIG = {
    'target_shape': (128, 128, 128),    # ç›®æ ‡ä½“ç§¯å°ºå¯¸
    'normalization': 'min_max',         # å½’ä¸€åŒ–æ–¹æ³•
    'crop_brain': True,                 # æ˜¯å¦è£å‰ªè„‘éƒ¨
    'augmentation': {
        'rotation_range': 15,           # æ—‹è½¬è§’åº¦èŒƒå›´
        'flip_probability': 0.5,        # ç¿»è½¬æ¦‚ç‡
        'elastic_deformation': True     # æ˜¯å¦å¯ç”¨å¼¹æ€§å˜å½¢
    }
}
```

### é¢„å¤„ç†æ•ˆæœå±•ç¤º

| å¤„ç†æ­¥éª¤ | åŸå§‹æ•°æ® | å¤„ç†å | æ”¹è¿›æ•ˆæœ |
|----------|----------|--------|----------|
| å°ºå¯¸ç»Ÿä¸€ | 240Ã—240Ã—155 | 128Ã—128Ã—128 | å‡å°‘å†…å­˜ä½¿ç”¨60% |
| å¼ºåº¦å½’ä¸€åŒ– | [0, 4095] | [0, 1] | æå‡è®­ç»ƒç¨³å®šæ€§ |
| è„‘éƒ¨è£å‰ª | åŒ…å«å¤§é‡èƒŒæ™¯ | èšç„¦è„‘ç»„ç»‡ | åŠ é€Ÿè®­ç»ƒ2-3å€ |

## ğŸ—ï¸ æ¨¡å‹æ¶æ„

### 3D U-Net æ ¸å¿ƒè®¾è®¡

æœ¬é¡¹ç›®é‡‡ç”¨**æ”¹è¿›çš„3D U-Netæ¶æ„**ï¼Œä¸“ä¸ºåŒ»å­¦å›¾åƒåˆ†å‰²ä¼˜åŒ–ï¼Œåœ¨ä¿æŒç»å…¸U-Netä¼˜åŠ¿çš„åŸºç¡€ä¸Šèå…¥äº†ç°ä»£æ·±åº¦å­¦ä¹ æŠ€æœ¯ã€‚

```
è¾“å…¥: 4é€šé“MRI (4Ã—128Ã—128Ã—128)
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç¼–ç å™¨è·¯å¾„     â”‚  ç‰¹å¾æå– + ä¸‹é‡‡æ ·
    â”‚  (Encoder)      â”‚  [16â†’32â†’64â†’128â†’256]
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç“¶é¢ˆå±‚        â”‚  æœ€æ·±å±‚ç‰¹å¾è¡¨ç¤º
    â”‚  (Bottleneck)   â”‚  256é€šé“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   è§£ç å™¨è·¯å¾„     â”‚  ç‰¹å¾èåˆ + ä¸Šé‡‡æ ·
    â”‚  (Decoder)      â”‚  [256â†’128â†’64â†’32â†’16]
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
è¾“å‡º: 4ç±»åˆ†å‰² (4Ã—128Ã—128Ã—128)
```

### ğŸš€ æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

#### 1. **æ®‹å·®è¿æ¥ (Residual Connections)**
- **åŸç†**ï¼šç¼“è§£æ·±å±‚ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜
- **å®ç°**ï¼šåœ¨æ¯ä¸ªå·ç§¯å—ä¸­æ·»åŠ è·³è·ƒè¿æ¥
- **æ•ˆæœ**ï¼šæå‡è®­ç»ƒç¨³å®šæ€§ï¼Œæ”¯æŒæ›´æ·±çš„ç½‘ç»œ

#### 2. **æ·±åº¦ç›‘ç£ (Deep Supervision)**
- **æœºåˆ¶**ï¼šåœ¨å¤šä¸ªè§£ç å™¨å±‚æ·»åŠ è¾…åŠ©åˆ†ç±»å™¨
- **æƒé‡ç­–ç•¥**ï¼šä¸»è¾“å‡ºæƒé‡1.0ï¼Œè¾…åŠ©è¾“å‡ºæƒé‡é€’å‡(0.5, 0.25, 0.125)
- **ä¼˜åŠ¿**ï¼šæ”¹å–„æ¢¯åº¦æµåŠ¨ï¼Œæå‡åˆ†å‰²è¾¹ç•Œç²¾åº¦

#### 3. **è·³è·ƒè¿æ¥ (Skip Connections)**
- **ä½œç”¨**ï¼šèåˆå¤šå°ºåº¦ç‰¹å¾ä¿¡æ¯
- **å®ç°**ï¼šç¼–ç å™¨ç‰¹å¾ç›´æ¥è¿æ¥åˆ°å¯¹åº”è§£ç å™¨å±‚
- **ä»·å€¼**ï¼šä¿ç•™ç»†èŠ‚ä¿¡æ¯ï¼Œæå‡å°ç›®æ ‡åˆ†å‰²æ•ˆæœ

### ğŸ“Š æ¨¡å‹è§„æ ¼

| ç»„ä»¶ | é…ç½® | è¯´æ˜ |
|------|------|------|
| **è¾“å…¥ç»´åº¦** | (4, 128, 128, 128) | 4ä¸ªMRIæ¨¡æ€ |
| **è¾“å‡ºç»´åº¦** | (4, 128, 128, 128) | 4ä¸ªåˆ†å‰²ç±»åˆ« |
| **ç‰¹å¾é€šé“** | [16, 32, 64, 128, 256] | é€å±‚é€’å¢ |
| **æ€»å‚æ•°é‡** | ~31M | å¹³è¡¡æ€§èƒ½ä¸æ•ˆç‡ |
| **æ˜¾å­˜éœ€æ±‚** | ~6GB | æ‰¹é‡å¤§å°=2æ—¶ |

### ğŸ¯ æŸå¤±å‡½æ•°è®¾è®¡

é‡‡ç”¨**ç»„åˆæŸå¤±å‡½æ•°**ï¼Œå¹³è¡¡åƒç´ çº§å‡†ç¡®æ€§å’ŒåŒºåŸŸçº§å®Œæ•´æ€§ï¼š

```python
æ€»æŸå¤± = äº¤å‰ç†µæŸå¤± + DiceæŸå¤±
```

- **äº¤å‰ç†µæŸå¤±**ï¼šä¼˜åŒ–åƒç´ çº§åˆ†ç±»å‡†ç¡®æ€§
- **DiceæŸå¤±**ï¼šç›´æ¥ä¼˜åŒ–åˆ†å‰²é‡å åº¦ï¼Œå¯¹å°ç›®æ ‡å‹å¥½

### ğŸ”§ æ¨¡å‹åˆ›å»ºç¤ºä¾‹

```python
from models.unet3d import UNet3D

# åˆ›å»ºæ¨¡å‹å®ä¾‹
model = UNet3D(
    in_channels=4,              # 4ä¸ªMRIæ¨¡æ€
    out_channels=4,             # 4ä¸ªåˆ†å‰²ç±»åˆ«
    features=[16, 32, 64, 128, 256],  # ç‰¹å¾é€šé“é…ç½®
    deep_supervision=True,      # å¯ç”¨æ·±åº¦ç›‘ç£
    residual=True              # å¯ç”¨æ®‹å·®è¿æ¥
)

print(f"æ¨¡å‹å‚æ•°é‡: {sum(p.numel() for p in model.parameters()):,}")
```

## ğŸš€ æ¨¡å‹è®­ç»ƒ

### å¿«é€Ÿå¼€å§‹

#### åŸºç¡€è®­ç»ƒå‘½ä»¤

```bash
python train.py \
    --data_dir ./data/BraTS2021_Training_Data \
    --output_dir ./output \
    --batch_size 2 \
    --epochs 100 \
    --lr 1e-4 \
    --deep_supervision \
    --residual
```

#### é«˜æ€§èƒ½è®­ç»ƒï¼ˆæ¨èï¼‰

```bash
python train.py \
    --data_dir ./data/BraTS2021_Training_Data \
    --output_dir ./output \
    --batch_size 2 \
    --epochs 100 \
    --lr 1e-4 \
    --deep_supervision \
    --residual \
    --amp \
    --num_workers 8
```

### ğŸ“‹ è®­ç»ƒå‚æ•°è¯¦è§£

#### æ ¸å¿ƒå‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èè®¾ç½® |
|------|--------|------|----------|
| `--data_dir` | å¿…éœ€ | BraTSæ•°æ®é›†è·¯å¾„ | `./data/BraTS2021_Training_Data` |
| `--output_dir` | `./output` | è®­ç»ƒè¾“å‡ºç›®å½• | `./output` |
| `--batch_size` | 2 | æ‰¹é‡å¤§å° | 2-4 (å–å†³äºGPUæ˜¾å­˜) |
| `--epochs` | 100 | è®­ç»ƒè½®æ•° | 100-200 |
| `--lr` | 1e-4 | åˆå§‹å­¦ä¹ ç‡ | 1e-4 |

#### æ¨¡å‹é…ç½®
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--in_channels` | 4 | è¾“å…¥é€šé“æ•° (4ä¸ªMRIæ¨¡æ€) |
| `--out_channels` | 4 | è¾“å‡ºé€šé“æ•° (4ä¸ªåˆ†å‰²ç±»åˆ«) |
| `--features` | [16,32,64,128,256] | å„å±‚ç‰¹å¾é€šé“æ•° |
| `--deep_supervision` | False | å¯ç”¨æ·±åº¦ç›‘ç£ |
| `--residual` | True | å¯ç”¨æ®‹å·®è¿æ¥ |

#### ä¼˜åŒ–é…ç½®
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | æ€§èƒ½æå‡ |
|------|--------|------|----------|
| `--amp` | False | æ··åˆç²¾åº¦è®­ç»ƒ | èŠ‚çœ50%æ˜¾å­˜ |
| `--distributed` | False | åˆ†å¸ƒå¼è®­ç»ƒ | å¤šGPUåŠ é€Ÿ |
| `--num_workers` | 4 | æ•°æ®åŠ è½½è¿›ç¨‹æ•° | å‡å°‘I/Oç­‰å¾… |

### ğŸ¯ è®­ç»ƒç­–ç•¥

#### å­¦ä¹ ç‡è°ƒåº¦
```python
# è‡ªé€‚åº”å­¦ä¹ ç‡è°ƒæ•´
scheduler = ReduceLROnPlateau(
    optimizer, 
    mode='max',           # ç›‘æ§Diceåˆ†æ•°æœ€å¤§åŒ–
    factor=0.5,          # å­¦ä¹ ç‡è¡°å‡å› å­
    patience=5,          # ç­‰å¾…è½®æ•°
    verbose=True
)
```

#### æ—©åœæœºåˆ¶
```python
# é˜²æ­¢è¿‡æ‹Ÿåˆçš„æ—©åœç­–ç•¥
early_stopping = EarlyStopping(
    patience=10,         # è¿ç»­10è½®æ— æ”¹å–„åˆ™åœæ­¢
    min_delta=0.001,     # æœ€å°æ”¹å–„é˜ˆå€¼
    restore_best_weights=True
)
```

### ğŸ“Š è®­ç»ƒç›‘æ§

#### TensorBoardå¯è§†åŒ–
```bash
# å¯åŠ¨TensorBoardæœåŠ¡
tensorboard --logdir ./output/logs --port 6006

# æµè§ˆå™¨è®¿é—®
http://localhost:6006
```

**ç›‘æ§æŒ‡æ ‡ï¼š**
- ğŸ“ˆ è®­ç»ƒ/éªŒè¯æŸå¤±æ›²çº¿
- ğŸ¯ Diceç³»æ•°å˜åŒ–è¶‹åŠ¿  
- ğŸ“ Hausdorffè·ç¦»ç»Ÿè®¡
- âš¡ å­¦ä¹ ç‡è°ƒæ•´å†å²
- ğŸ–¼ï¸ é¢„æµ‹ç»“æœå¯è§†åŒ–

#### å®æ—¶è¿›åº¦æ˜¾ç¤º
```
Epoch 25/100 â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 100% 
â”œâ”€â”€ è®­ç»ƒæŸå¤±: 0.2341
â”œâ”€â”€ éªŒè¯æŸå¤±: 0.1987  
â”œâ”€â”€ éªŒè¯Dice: 0.8756
â”œâ”€â”€ éªŒè¯Hausdorff: 2.34
â””â”€â”€ å­¦ä¹ ç‡: 1e-4
```

### âš¡ é«˜çº§è®­ç»ƒç‰¹æ€§

#### ğŸ”¥ æ··åˆç²¾åº¦è®­ç»ƒ (AMP)
**æ˜¾è‘—æå‡è®­ç»ƒæ•ˆç‡ï¼ŒèŠ‚çœGPUæ˜¾å­˜**

```bash
# å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
python train.py --amp --batch_size 4  # å¯ä»¥ä½¿ç”¨æ›´å¤§çš„æ‰¹é‡
```

**ä¼˜åŠ¿ï¼š**
- ğŸ’¾ **æ˜¾å­˜èŠ‚çœ**ï¼šå‡å°‘50%æ˜¾å­˜ä½¿ç”¨
- ğŸš€ **é€Ÿåº¦æå‡**ï¼šè®­ç»ƒé€Ÿåº¦æå‡1.5-2å€
- ğŸ¯ **ç²¾åº¦ä¿æŒ**ï¼šå‡ ä¹æ— ç²¾åº¦æŸå¤±

#### ğŸŒ åˆ†å¸ƒå¼è®­ç»ƒ
**å¤šGPUå¹¶è¡Œè®­ç»ƒï¼Œå¤§å¹…ç¼©çŸ­è®­ç»ƒæ—¶é—´**

```bash
# å•æœºå¤šGPUè®­ç»ƒ
python -m torch.distributed.launch \
    --nproc_per_node=4 \
    train.py \
    --distributed \
    --batch_size 2  # æ¯ä¸ªGPUçš„æ‰¹é‡å¤§å°
```

**é…ç½®è¯´æ˜ï¼š**
- `--nproc_per_node=N`ï¼šä½¿ç”¨Nä¸ªGPU
- æ€»æ‰¹é‡å¤§å° = `batch_size Ã— GPUæ•°é‡`
- è‡ªåŠ¨å¤„ç†æ¢¯åº¦åŒæ­¥å’Œæ¨¡å‹å¹¶è¡Œ

#### ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| é…ç½® | è®­ç»ƒæ—¶é—´/epoch | æ˜¾å­˜ä½¿ç”¨ | æ‰¹é‡å¤§å° |
|------|----------------|----------|----------|
| åŸºç¡€è®­ç»ƒ | 15åˆ†é’Ÿ | 8GB | 2 |
| + æ··åˆç²¾åº¦ | 8åˆ†é’Ÿ | 4GB | 4 |
| + åˆ†å¸ƒå¼(4GPU) | 3åˆ†é’Ÿ | 4GBÃ—4 | 8 |

## ğŸ“Š è¯„ä¼°æŒ‡æ ‡ä½“ç³»

### æ ¸å¿ƒè¯„ä¼°æŒ‡æ ‡

#### ğŸ¯ Diceç³»æ•° (Dice Coefficient)
**è¡¡é‡åˆ†å‰²é‡å åº¦çš„é‡‘æ ‡å‡†æŒ‡æ ‡**

```python
Dice = (2 Ã— |é¢„æµ‹ âˆ© çœŸå®|) / (|é¢„æµ‹| + |çœŸå®|)
```

**ç‰¹ç‚¹ï¼š**
- ğŸ“ˆ **å€¼åŸŸ**ï¼š[0, 1]ï¼Œ1è¡¨ç¤ºå®Œç¾åˆ†å‰²
- ğŸ¯ **ä¼˜åŠ¿**ï¼šå¯¹å°ç›®æ ‡æ•æ„Ÿï¼ŒåŒ»å­¦å›¾åƒåˆ†å‰²é¦–é€‰
- ğŸ“Š **è§£é‡Š**ï¼š0.8+ä¸ºä¼˜ç§€ï¼Œ0.9+ä¸ºå“è¶Š

#### ğŸ“ Hausdorffè·ç¦» (Hausdorff Distance)
**è¯„ä¼°åˆ†å‰²è¾¹ç•Œç²¾ç¡®åº¦çš„å‡ ä½•æŒ‡æ ‡**

```python
HD = max(h(Aâ†’B), h(Bâ†’A))
å…¶ä¸­ h(Aâ†’B) = max{min{d(a,b) : bâˆˆB} : aâˆˆA}
```

**ç‰¹ç‚¹ï¼š**
- ğŸ“ **å•ä½**ï¼šåƒç´ /æ¯«ç±³
- ğŸ¯ **æ„ä¹‰**ï¼šå€¼è¶Šå°è¾¹ç•Œè¶Šç²¾ç¡®
- ğŸ“Š **åº”ç”¨**ï¼šä¸´åºŠè¾¹ç•Œè¯„ä¼°çš„é‡è¦æŒ‡æ ‡

### ğŸ“ˆ å¤šç±»åˆ«è¯„ä¼°

#### åˆ†ç±»åˆ«æ€§èƒ½ç»Ÿè®¡
| è§£å‰–ç»“æ„ | Diceç›®æ ‡ | HD95ç›®æ ‡ | ä¸´åºŠé‡è¦æ€§ |
|----------|----------|----------|------------|
| åæ­»æ ¸å¿ƒ (NCR) | >0.85 | <3.0mm | â­â­â­â­â­ |
| æ°´è‚¿åŒºåŸŸ (ED) | >0.80 | <4.0mm | â­â­â­â­ |
| å¢å¼ºè‚¿ç˜¤ (ET) | >0.75 | <3.5mm | â­â­â­â­â­ |

#### ç»¼åˆè¯„ä¼°æŒ‡æ ‡
```python
# å¹³å‡Diceåˆ†æ•°
Mean_Dice = (Dice_NCR + Dice_ED + Dice_ET) / 3

# åŠ æƒDiceåˆ†æ•°ï¼ˆè€ƒè™‘ä¸´åºŠé‡è¦æ€§ï¼‰
Weighted_Dice = (0.4Ã—Dice_NCR + 0.3Ã—Dice_ED + 0.3Ã—Dice_ET)
```

### ğŸ” è¯„ä¼°æŠ¥å‘Šç¤ºä¾‹

```
==================== æ¨¡å‹è¯„ä¼°æŠ¥å‘Š ====================
ğŸ“Š æ•´ä½“æ€§èƒ½:
â”œâ”€â”€ å¹³å‡Diceåˆ†æ•°: 0.8756 Â± 0.0234
â”œâ”€â”€ å¹³å‡HD95è·ç¦»: 2.87 Â± 1.23 mm
â””â”€â”€ æ¨ç†é€Ÿåº¦: 1.2ç§’/ç—…ä¾‹

ğŸ¯ åˆ†ç±»åˆ«æ€§èƒ½:
â”œâ”€â”€ åæ­»æ ¸å¿ƒ (NCR):
â”‚   â”œâ”€â”€ Dice: 0.8934 Â± 0.0456
â”‚   â””â”€â”€ HD95: 2.34 Â± 0.87 mm
â”œâ”€â”€ æ°´è‚¿åŒºåŸŸ (ED):
â”‚   â”œâ”€â”€ Dice: 0.8456 Â± 0.0234
â”‚   â””â”€â”€ HD95: 3.12 Â± 1.45 mm
â””â”€â”€ å¢å¼ºè‚¿ç˜¤ (ET):
    â”œâ”€â”€ Dice: 0.8878 Â± 0.0345
    â””â”€â”€ HD95: 3.15 Â± 1.67 mm

âœ… æ€§èƒ½è¯„çº§: ä¼˜ç§€ (æ‰€æœ‰æŒ‡æ ‡å‡è¾¾åˆ°ä¸´åºŠåº”ç”¨æ ‡å‡†)
```

## ğŸ”® æ¨¡å‹æ¨ç†

### å¿«é€Ÿæ¨ç†

#### å•ç—…ä¾‹æ¨ç†
```bash
python inference.py \
    --input_dir ./data/BraTS2021_Training_Data/BraTS2021_00000 \
    --output_dir ./predictions \
    --model_path ./output/checkpoints/best_model.pth \
    --visualize
```

#### æ‰¹é‡æ¨ç†
```bash
python inference.py \
    --input_dir ./data/BraTS2021_Training_Data \
    --output_dir ./predictions \
    --model_path ./output/checkpoints/best_model.pth \
    --visualize \
    --create_gif
```

### ğŸ“‹ æ¨ç†å‚æ•°è¯´æ˜

| å‚æ•° | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `--input_dir` | âœ… | è¾“å…¥MRIæ•°æ®ç›®å½• | `./data/test_cases` |
| `--output_dir` | âœ… | é¢„æµ‹ç»“æœä¿å­˜ç›®å½• | `./predictions` |
| `--model_path` | âœ… | è®­ç»ƒå¥½çš„æ¨¡å‹è·¯å¾„ | `./output/checkpoints/best_model.pth` |
| `--visualize` | âŒ | ç”Ÿæˆå¯è§†åŒ–ç»“æœ | é»˜è®¤å¯ç”¨ |
| `--create_gif` | âŒ | åˆ›å»º3DåŠ¨ç”» | å¯é€‰ |
| `--target_shape` | âŒ | å¤„ç†å°ºå¯¸ | `[128,128,128]` |

### ğŸ“ è¾“å‡ºç»“æœç»“æ„

```
predictions/
â”œâ”€â”€ ğŸ“‚ BraTS2021_00000/
â”‚   â”œâ”€â”€ ğŸ¯ BraTS2021_00000_pred.nii.gz     # åˆ†å‰²é¢„æµ‹ç»“æœ
â”‚   â”œâ”€â”€ ğŸ“Š BraTS2021_00000_metrics.json    # è¯„ä¼°æŒ‡æ ‡
â”‚   â””â”€â”€ ğŸ“‚ visualizations/
â”‚       â”œâ”€â”€ ğŸ–¼ï¸ prediction_overview.png     # å¤šåˆ‡ç‰‡å¯¹æ¯”å›¾
â”‚       â”œâ”€â”€ ğŸ¬ 3d_segmentation.gif         # 3DåŠ¨ç”»
â”‚       â””â”€â”€ ğŸ“ˆ confidence_map.png          # ç½®ä¿¡åº¦çƒ­å›¾
â”œâ”€â”€ ğŸ“‚ BraTS2021_00001/
â”‚   â””â”€â”€ ...
â””â”€â”€ ğŸ“‹ inference_summary.json              # æ‰¹é‡æ¨ç†æ±‡æ€»
```

### ğŸ¨ å¯è§†åŒ–åŠŸèƒ½

#### 2Dåˆ‡ç‰‡å¯¹æ¯”
- **åŸå§‹FLAIRå›¾åƒ**ï¼šæä¾›è§£å‰–å­¦èƒŒæ™¯
- **çœŸå®æ ‡æ³¨**ï¼šä¸“å®¶æ ‡æ³¨çš„é‡‘æ ‡å‡†
- **æ¨¡å‹é¢„æµ‹**ï¼šAIåˆ†å‰²ç»“æœ
- **å·®å¼‚åˆ†æ**ï¼šé”™è¯¯åŒºåŸŸé«˜äº®æ˜¾ç¤º

#### 3DåŠ¨ç”»å¯è§†åŒ–
```bash
# åˆ›å»ºé«˜è´¨é‡3D GIFåŠ¨ç”»
python inference.py \
    --create_gif \
    --gif_duration 150  # æ¯å¸§150ms
```

### âš¡ æ¨ç†æ€§èƒ½

| ç¡¬ä»¶é…ç½® | æ¨ç†é€Ÿåº¦ | å†…å­˜ä½¿ç”¨ | æ‰¹é‡å¤„ç† |
|----------|----------|----------|----------|
| RTX 3080 | 1.2ç§’/ç—…ä¾‹ | 4GB | æ”¯æŒ |
| RTX 4090 | 0.8ç§’/ç—…ä¾‹ | 6GB | æ”¯æŒ |
| CPU (16æ ¸) | 15ç§’/ç—…ä¾‹ | 8GB | æ”¯æŒ |

### ğŸ”§ æ¨ç†è„šæœ¬ç¤ºä¾‹

```python
from inference import load_model, preprocess_scan
import torch

# åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹
device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
model, args = load_model('./output/checkpoints/best_model.pth', device)

# é¢„å¤„ç†å•ä¸ªç—…ä¾‹
image_tensor, affine, header = preprocess_scan(
    t1_path='./case/t1.nii.gz',
    t1ce_path='./case/t1ce.nii.gz', 
    t2_path='./case/t2.nii.gz',
    flair_path='./case/flair.nii.gz',
    target_shape=[128, 128, 128]
)

# æ¨¡å‹æ¨ç†
with torch.no_grad():
    prediction = model(image_tensor.to(device))
    
print(f"æ¨ç†å®Œæˆï¼é¢„æµ‹å½¢çŠ¶: {prediction.shape}")
```

## ğŸ¨ å¯è§†åŒ–å·¥å…·é›†

### ğŸ“Š è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ–

#### TensorBoardå®æ—¶ç›‘æ§
```bash
# å¯åŠ¨TensorBoardæœåŠ¡
tensorboard --logdir ./output/logs --port 6006

# åœ¨æµè§ˆå™¨ä¸­è®¿é—®
http://localhost:6006
```

**ç›‘æ§å†…å®¹ï¼š**
- ğŸ“ˆ **æŸå¤±æ›²çº¿**ï¼šè®­ç»ƒ/éªŒè¯æŸå¤±å®æ—¶å˜åŒ–
- ğŸ¯ **æ€§èƒ½æŒ‡æ ‡**ï¼šDiceç³»æ•°ã€Hausdorffè·ç¦»è¶‹åŠ¿
- ğŸ”§ **è¶…å‚æ•°**ï¼šå­¦ä¹ ç‡è°ƒæ•´å†å²
- ğŸ–¼ï¸ **æ ·æœ¬é¢„æµ‹**ï¼šæ¯ä¸ªepochçš„é¢„æµ‹ç»“æœå±•ç¤º
- ğŸ“Š **æ¨¡å‹ç»“æ„**ï¼šç½‘ç»œæ¶æ„å¯è§†åŒ–

### ğŸ–¼ï¸ åˆ†å‰²ç»“æœå¯è§†åŒ–

#### å¤šé¢æ¿å¯¹æ¯”å›¾
```python
# è‡ªåŠ¨ç”Ÿæˆ4é¢æ¿å¯¹æ¯”å›¾
save_prediction_visualization(
    images=mri_data,      # å¤šæ¨¡æ€MRIè¾“å…¥
    masks=ground_truth,   # çœŸå®åˆ†å‰²æ ‡ç­¾  
    outputs=predictions,  # æ¨¡å‹é¢„æµ‹ç»“æœ
    save_path='./vis/comparison.png'
)
```

**é¢æ¿å¸ƒå±€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸå§‹FLAIR  â”‚  çœŸå®æ ‡æ³¨   â”‚  æ¨¡å‹é¢„æµ‹   â”‚  å·®å¼‚åˆ†æ   â”‚
â”‚             â”‚             â”‚             â”‚             â”‚
â”‚  ç°åº¦æ˜¾ç¤º   â”‚  å½©è‰²å åŠ    â”‚  å½©è‰²å åŠ    â”‚  é”™è¯¯é«˜äº®   â”‚
â”‚  è§£å‰–èƒŒæ™¯   â”‚  ä¸“å®¶æ ‡æ³¨   â”‚  AIé¢„æµ‹     â”‚  çº¢è‰²æ ‡è®°   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é¢œè‰²ç¼–ç æ–¹æ¡ˆ
| è§£å‰–ç»“æ„ | é¢œè‰² | RGBå€¼ | ä¸´åºŠæ„ä¹‰ |
|----------|------|-------|----------|
| åæ­»æ ¸å¿ƒ | ğŸ”´ çº¢è‰² | (255,0,0) | è‚¿ç˜¤åæ­»åŒºåŸŸ |
| æ°´è‚¿åŒºåŸŸ | ğŸŸ¢ ç»¿è‰² | (0,255,0) | å‘¨å›´æ°´è‚¿ |
| å¢å¼ºè‚¿ç˜¤ | ğŸ”µ è“è‰² | (0,0,255) | æ´»è·ƒè‚¿ç˜¤ |
| èƒŒæ™¯ç»„ç»‡ | âš« é€æ˜ | - | æ­£å¸¸è„‘ç»„ç»‡ |

### ğŸ¬ 3DåŠ¨ç”»å¯è§†åŒ–

#### åˆ›å»º3D GIFåŠ¨ç”»
```bash
# ç”Ÿæˆé«˜è´¨é‡3DåŠ¨ç”»
python -c "
from utils.visualization import create_3d_gif
import nibabel as nib

# åŠ è½½åˆ†å‰²ç»“æœ
seg = nib.load('./predictions/case_pred.nii.gz').get_fdata()

# åˆ›å»ºåŠ¨ç”»
create_3d_gif(
    volume=seg,
    save_path='./vis/3d_segmentation.gif',
    duration=100,           # æ¯å¸§100ms
    cmap='tab10',          # ç¦»æ•£é¢œè‰²æ˜ å°„
    title_prefix='åˆ‡ç‰‡'
)
"
```

**åŠ¨ç”»ç‰¹ç‚¹ï¼š**
- ğŸï¸ **é€åˆ‡ç‰‡æ’­æ”¾**ï¼šä»å¤´åˆ°å°¾å®Œæ•´å±•ç¤º3Dç»“æ„
- ğŸ¨ **é¢œè‰²åŒºåˆ†**ï¼šä¸åŒç±»åˆ«ä½¿ç”¨ä¸åŒé¢œè‰²
- ğŸ“ **å°ºå¯¸æ ‡æ³¨**ï¼šæ˜¾ç¤ºå½“å‰åˆ‡ç‰‡ä½ç½®
- âš¡ **æµç•…æ’­æ”¾**ï¼šå¯è°ƒèŠ‚æ’­æ”¾é€Ÿåº¦

### ğŸ“ˆ é«˜çº§å¯è§†åŒ–åŠŸèƒ½

#### ç½®ä¿¡åº¦çƒ­å›¾
```python
# ç”Ÿæˆé¢„æµ‹ç½®ä¿¡åº¦å¯è§†åŒ–
confidence_map = torch.softmax(raw_predictions, dim=1).max(dim=1)[0]
plt.imshow(confidence_map[slice_idx], cmap='hot', alpha=0.7)
plt.colorbar(label='é¢„æµ‹ç½®ä¿¡åº¦')
```

#### 3Dä½“ç§¯æ¸²æŸ“
```python
# ä½¿ç”¨matplotlibè¿›è¡Œ3Då¯è§†åŒ–
from mpl_toolkits.mplot3d import Axes3D

fig = plt.figure(figsize=(12, 8))
ax = fig.add_subplot(111, projection='3d')

# 3Dæ•£ç‚¹å›¾æ˜¾ç¤ºè‚¿ç˜¤ä½ç½®
tumor_coords = np.where(segmentation > 0)
ax.scatter(tumor_coords[0], tumor_coords[1], tumor_coords[2], 
          c=segmentation[tumor_coords], cmap='viridis', alpha=0.6)
```

### ğŸ” å¯è§†åŒ–æœ€ä½³å®è·µ

#### è´¨é‡æ§åˆ¶æ£€æŸ¥æ¸…å•
- âœ… **è§£å‰–å­¦åˆç†æ€§**ï¼šåˆ†å‰²ç»“æœç¬¦åˆåŒ»å­¦å¸¸è¯†
- âœ… **è¾¹ç•Œè¿ç»­æ€§**ï¼šç›¸é‚»åˆ‡ç‰‡é—´çš„ä¸€è‡´æ€§
- âœ… **å¯¹ç§°æ€§æ£€æŸ¥**ï¼šå·¦å³åŠçƒçš„å¯¹ç§°æ€§åˆ†æ
- âœ… **å°ºå¯¸åˆç†æ€§**ï¼šè‚¿ç˜¤å¤§å°åœ¨åˆç†èŒƒå›´å†…

#### ä¸´åºŠæŠ¥å‘Šç”Ÿæˆ
```python
# è‡ªåŠ¨ç”Ÿæˆä¸´åºŠæŠ¥å‘Š
def generate_clinical_report(segmentation, patient_id):
    report = {
        'patient_id': patient_id,
        'tumor_volume': calculate_volume(segmentation),
        'tumor_location': analyze_location(segmentation),
        'risk_assessment': assess_risk(segmentation),
        'recommendations': generate_recommendations(segmentation)
    }
    return report
```

## âš™ï¸ å®éªŒé…ç½®ä¸è¶…å‚æ•°è°ƒä¼˜

### ğŸ¯ æ¨èé…ç½®

#### åŸºç¡€é…ç½® (å…¥é—¨çº§)
```yaml
# é€‚åˆå•GPUè®­ç»ƒï¼Œæ˜¾å­˜éœ€æ±‚è¾ƒä½
model:
  batch_size: 2
  learning_rate: 1e-4
  weight_decay: 1e-5
  
training:
  epochs: 100
  patience: 10
  
optimizer:
  type: Adam
  betas: [0.9, 0.999]
  eps: 1e-8
```

#### é«˜æ€§èƒ½é…ç½® (æ¨è)
```yaml
# é€‚åˆå¤šGPUè®­ç»ƒï¼Œè¿½æ±‚æœ€ä½³æ€§èƒ½
model:
  batch_size: 4          # ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
  learning_rate: 2e-4    # ç¨é«˜å­¦ä¹ ç‡é…åˆå¤§æ‰¹é‡
  weight_decay: 1e-5
  
training:
  epochs: 200
  patience: 15
  amp: true              # å¯ç”¨æ··åˆç²¾åº¦
  
optimizer:
  type: AdamW            # æ›´å¥½çš„æƒé‡è¡°å‡
  betas: [0.9, 0.999]
  eps: 1e-8
```

### ğŸ“Š è¶…å‚æ•°å½±å“åˆ†æ

#### å­¦ä¹ ç‡è°ƒä¼˜
| å­¦ä¹ ç‡ | æ”¶æ•›é€Ÿåº¦ | æœ€ç»ˆæ€§èƒ½ | ç¨³å®šæ€§ | æ¨èåœºæ™¯ |
|--------|----------|----------|--------|----------|
| 1e-3 | å¾ˆå¿« | ä¸­ç­‰ | è¾ƒå·® | å¿«é€ŸåŸå‹ |
| 1e-4 | é€‚ä¸­ | ä¼˜ç§€ | å¾ˆå¥½ | **æ ‡å‡†è®­ç»ƒ** |
| 1e-5 | è¾ƒæ…¢ | è‰¯å¥½ | æä½³ | ç²¾ç»†è°ƒä¼˜ |

#### æ‰¹é‡å¤§å°å½±å“
```python
# æ‰¹é‡å¤§å°ä¸æ€§èƒ½å…³ç³»
batch_size_effects = {
    1: {"memory": "2GB", "speed": "æ…¢", "stability": "é«˜"},
    2: {"memory": "4GB", "speed": "ä¸­", "stability": "é«˜"},    # æ¨è
    4: {"memory": "8GB", "speed": "å¿«", "stability": "ä¸­"},    # éœ€è¦AMP
    8: {"memory": "16GB", "speed": "å¾ˆå¿«", "stability": "ä½"}  # éœ€è¦å¤šGPU
}
```

### ğŸ”§ å­¦ä¹ ç‡è°ƒåº¦ç­–ç•¥

#### ReduceLROnPlateau (æ¨è)
```python
scheduler = ReduceLROnPlateau(
    optimizer,
    mode='max',              # ç›‘æ§Diceåˆ†æ•°æœ€å¤§åŒ–
    factor=0.5,             # å­¦ä¹ ç‡è¡°å‡å› å­
    patience=5,             # ç­‰å¾…è½®æ•°
    min_lr=1e-7,           # æœ€å°å­¦ä¹ ç‡
    verbose=True
)
```

#### CosineAnnealingLR (é«˜çº§)
```python
scheduler = CosineAnnealingLR(
    optimizer,
    T_max=100,              # å‘¨æœŸé•¿åº¦
    eta_min=1e-7,          # æœ€å°å­¦ä¹ ç‡
    last_epoch=-1
)
```

### ğŸ² æ•°æ®å¢å¼ºç­–ç•¥

#### ä¿å®ˆç­–ç•¥ (ç¨³å®šæ€§ä¼˜å…ˆ)
```python
augmentation_config = {
    'rotation_range': 10,        # è¾ƒå°æ—‹è½¬è§’åº¦
    'flip_probability': 0.3,     # è¾ƒä½ç¿»è½¬æ¦‚ç‡
    'elastic_alpha': 10,         # è½»å¾®å¼¹æ€§å˜å½¢
    'elastic_sigma': 3
}
```

#### æ¿€è¿›ç­–ç•¥ (å¤šæ ·æ€§ä¼˜å…ˆ)
```python
augmentation_config = {
    'rotation_range': 20,        # è¾ƒå¤§æ—‹è½¬è§’åº¦
    'flip_probability': 0.7,     # è¾ƒé«˜ç¿»è½¬æ¦‚ç‡
    'elastic_alpha': 20,         # å¼ºå¼¹æ€§å˜å½¢
    'elastic_sigma': 4,
    'noise_std': 0.1            # æ·»åŠ é«˜æ–¯å™ªå£°
}
```

### ğŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•

#### ä¸åŒé…ç½®çš„æ€§èƒ½å¯¹æ¯”
| é…ç½® | è®­ç»ƒæ—¶é—´ | éªŒè¯Dice | æ˜¾å­˜ä½¿ç”¨ | æ¨èæŒ‡æ•° |
|------|----------|----------|----------|----------|
| åŸºç¡€é…ç½® | 8å°æ—¶ | 0.875 | 6GB | â­â­â­ |
| æ¨èé…ç½® | 6å°æ—¶ | 0.892 | 8GB | â­â­â­â­â­ |
| æ¿€è¿›é…ç½® | 4å°æ—¶ | 0.888 | 12GB | â­â­â­â­ |

### ğŸ” è°ƒä¼˜å»ºè®®

#### é˜¶æ®µæ€§è°ƒä¼˜ç­–ç•¥
```python
# ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿæ”¶æ•› (0-50 epochs)
stage1_config = {
    'lr': 2e-4,
    'batch_size': 4,
    'augmentation': 'conservative'
}

# ç¬¬äºŒé˜¶æ®µï¼šç²¾ç»†è°ƒä¼˜ (50-100 epochs)  
stage2_config = {
    'lr': 5e-5,
    'batch_size': 2,
    'augmentation': 'aggressive'
}

# ç¬¬ä¸‰é˜¶æ®µï¼šç¨³å®šæ”¶æ•› (100+ epochs)
stage3_config = {
    'lr': 1e-5,
    'batch_size': 2,
    'augmentation': 'minimal'
}
```

#### è¶…å‚æ•°æœç´¢
```bash
# ä½¿ç”¨Optunaè¿›è¡Œè‡ªåŠ¨è¶…å‚æ•°ä¼˜åŒ–
python hyperparameter_search.py \
    --n_trials 50 \
    --search_space lr,batch_size,weight_decay
```

## ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—

### 5åˆ†é’Ÿå¿«é€Ÿä½“éªŒ

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/3D-UNet-BraTS.git
cd 3D-UNet-BraTS

# 2. å®‰è£…ç¯å¢ƒ
conda create -n unet3d python=3.8 -y
conda activate unet3d
pip install -r requirements.txt

# 3. ä¸‹è½½ç¤ºä¾‹æ•°æ® (å¯é€‰)
# è¯·ä»BraTSå®˜ç½‘ä¸‹è½½å®Œæ•´æ•°æ®é›†

# 4. å¼€å§‹è®­ç»ƒ
python train.py --data_dir ./data/BraTS2021_Training_Data --epochs 10

# 5. è¿è¡Œæ¨ç†
python inference.py --model_path ./output/checkpoints/best_model.pth
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿ç¤¾åŒºè´¡çŒ®ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

### è´¡çŒ®ç±»å‹
- ğŸ› **Bugä¿®å¤**ï¼šå‘ç°å¹¶ä¿®å¤ä»£ç ä¸­çš„é—®é¢˜
- âœ¨ **æ–°åŠŸèƒ½**ï¼šæ·»åŠ æœ‰ç”¨çš„æ–°ç‰¹æ€§
- ğŸ“š **æ–‡æ¡£æ”¹è¿›**ï¼šå®Œå–„æ–‡æ¡£å’Œæ³¨é‡Š
- ğŸ¨ **ä»£ç ä¼˜åŒ–**ï¼šæå‡ä»£ç è´¨é‡å’Œæ€§èƒ½

### è´¡çŒ®æµç¨‹
1. **Forké¡¹ç›®** â†’ åˆ›å»ºä½ çš„åŠŸèƒ½åˆ†æ”¯
2. **å¼€å‘æµ‹è¯•** â†’ ç¡®ä¿ä»£ç è´¨é‡å’Œæµ‹è¯•è¦†ç›–
3. **æäº¤PR** â†’ è¯¦ç»†æè¿°ä½ çš„æ”¹åŠ¨
4. **ä»£ç å®¡æŸ¥** â†’ å“åº”å®¡æŸ¥æ„è§
5. **åˆå¹¶ä»£ç ** â†’ æˆåŠŸåˆå¹¶åˆ°ä¸»åˆ†æ”¯

### ä»£ç è§„èŒƒ
```python
# éµå¾ªPEP 8ä»£ç é£æ ¼
# æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
# åŒ…å«å•å…ƒæµ‹è¯•
# æ›´æ–°ç›¸å…³æ–‡æ¡£
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜ (FAQ)

#### Q: è®­ç»ƒæ—¶æ˜¾å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
A: å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š
- å‡å°æ‰¹é‡å¤§å°ï¼š`--batch_size 1`
- å¯ç”¨æ··åˆç²¾åº¦ï¼š`--amp`
- å‡å°è¾“å…¥å°ºå¯¸ï¼š`--target_shape 96 96 96`

#### Q: å¦‚ä½•æå‡æ¨¡å‹æ€§èƒ½ï¼Ÿ
A: å»ºè®®çš„ä¼˜åŒ–ç­–ç•¥ï¼š
- å¢åŠ è®­ç»ƒè½®æ•°ï¼š`--epochs 200`
- å¯ç”¨æ·±åº¦ç›‘ç£ï¼š`--deep_supervision`
- è°ƒæ•´å­¦ä¹ ç‡ï¼š`--lr 2e-4`
- ä½¿ç”¨æ•°æ®å¢å¼º

#### Q: æ¨ç†é€Ÿåº¦å¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ
A: åŠ é€Ÿæ¨ç†çš„æ–¹æ³•ï¼š
- ä½¿ç”¨GPUæ¨ç†
- å¯ç”¨æ··åˆç²¾åº¦
- æ‰¹é‡å¤„ç†å¤šä¸ªç—…ä¾‹
- è€ƒè™‘æ¨¡å‹é‡åŒ–

### è”ç³»æ–¹å¼
- ğŸ“§ **é‚®ç®±**ï¼šyour-email@example.com
- ğŸ’¬ **è®¨è®ºåŒº**ï¼š[GitHub Discussions](https://github.com/your-repo/discussions)
- ğŸ› **é—®é¢˜åé¦ˆ**ï¼š[GitHub Issues](https://github.com/your-repo/issues)
- ğŸ“– **æ–‡æ¡£**ï¼š[é¡¹ç›®Wiki](https://github.com/your-repo/wiki)

## ğŸ“š ç›¸å…³èµ„æº

### å­¦æœ¯è®ºæ–‡
- **U-NetåŸè®ºæ–‡**ï¼š[U-Net: Convolutional Networks for Biomedical Image Segmentation](https://arxiv.org/abs/1505.04597)
- **3D U-Net**ï¼š[3D U-Net: Learning Dense Volumetric Segmentation from Sparse Annotation](https://arxiv.org/abs/1606.06650)
- **BraTSæŒ‘æˆ˜èµ›**ï¼š[The Multimodal Brain Tumor Image Segmentation Benchmark (BRATS)](https://arxiv.org/abs/1811.02629)

### ç›¸å…³é¡¹ç›®
- [nnU-Net](https://github.com/MIC-DKFZ/nnUNet) - åŒ»å­¦å›¾åƒåˆ†å‰²çš„è‡ªé…ç½®æ¡†æ¶
- [MONAI](https://github.com/Project-MONAI/MONAI) - åŒ»å­¦å›¾åƒæ·±åº¦å­¦ä¹ æ¡†æ¶
- [TorchIO](https://github.com/fepegar/torchio) - åŒ»å­¦å›¾åƒé¢„å¤„ç†åº“

### æ•°æ®é›†èµ„æº
- [BraTS Challenge](https://www.med.upenn.edu/cbica/brats2021/) - å®˜æ–¹æŒ‘æˆ˜èµ›ç½‘ç«™
- [Medical Segmentation Decathlon](http://medicaldecathlon.com/) - å¤šå™¨å®˜åˆ†å‰²æ•°æ®é›†
- [OASIS](https://www.oasis-brains.org/) - è„‘éƒ¨MRIæ•°æ®é›†

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ **MITè®¸å¯è¯** å¼€æºï¼Œè¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

```
MIT License

Copyright (c) 2024 3D U-Net BraTS Project

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
```

## ğŸ™ è‡´è°¢

### ç‰¹åˆ«æ„Ÿè°¢
- ğŸ¥ **BraTSæŒ‘æˆ˜èµ›ç»„ç»‡è€…**ï¼šæä¾›é«˜è´¨é‡çš„è„‘è‚¿ç˜¤åˆ†å‰²æ•°æ®é›†
- ğŸ§  **åŒ»å­¦ä¸“å®¶**ï¼šæä¾›ä¸“ä¸šçš„æ ‡æ³¨å’Œä¸´åºŠæŒ‡å¯¼
- ğŸ’» **å¼€æºç¤¾åŒº**ï¼šPyTorchã€MONAIç­‰ä¼˜ç§€æ¡†æ¶çš„æ”¯æŒ
- ğŸ“ **å­¦æœ¯ç•Œ**ï¼šU-Netç­‰ç»å…¸ç®—æ³•çš„è´¡çŒ®è€…

### å¼•ç”¨æœ¬é¡¹ç›®
å¦‚æœæœ¬é¡¹ç›®å¯¹æ‚¨çš„ç ”ç©¶æœ‰å¸®åŠ©ï¼Œè¯·è€ƒè™‘å¼•ç”¨ï¼š

```bibtex
@software{3d_unet_brats_2024,
  title={3D U-Net for Brain Tumor Segmentation},
  author={Your Name},
  year={2024},
  url={https://github.com/your-repo/3D-UNet-BraTS}
}
```

---

<div align="center">

**ğŸŒŸ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ªStarï¼ğŸŒŸ**

[![GitHub stars](https://img.shields.io/github/stars/your-repo/3D-UNet-BraTS.svg?style=social&label=Star)](https://github.com/your-repo/3D-UNet-BraTS)
[![GitHub forks](https://img.shields.io/github/forks/your-repo/3D-UNet-BraTS.svg?style=social&label=Fork)](https://github.com/your-repo/3D-UNet-BraTS)

</div>